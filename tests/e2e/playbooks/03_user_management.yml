# E2E Test Playbook: User Management
# Tests: user, file, copy, command, template modules
---
- name: User Management and Access Control
  hosts: all
  become: true
  gather_facts: true
  vars:
    app_users:
      - name: deploy
        comment: "Deployment User"
        groups: ["sudo", "www-data"]
        shell: /bin/bash
      - name: monitor
        comment: "Monitoring User"
        groups: []
        shell: /bin/bash
      - name: backup
        comment: "Backup Service User"
        groups: []
        shell: /bin/bash
        system: true

    ssh_keys:
      deploy: "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQC... deploy@example.com"
      monitor: "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQC... monitor@example.com"

    sudoers_nopasswd:
      - deploy

  tasks:
    - name: Create application groups
      command: groupadd -f {{ item }}
      loop:
        - www-data
        - deploy
        - monitoring
      register: group_result
      changed_when: group_result.rc == 0
      failed_when: false

    - name: Create application users
      user:
        name: "{{ item.name }}"
        comment: "{{ item.comment }}"
        shell: "{{ item.shell | default('/bin/bash') }}"
        create_home: true
        state: present
      loop: "{{ app_users }}"
      register: created_users

    - name: Add users to groups
      command: usermod -aG {{ item.1 }} {{ item.0.name }}
      loop: "{{ app_users | subelements('groups', skip_missing=True) }}"
      when: item.1 | length > 0
      register: usermod_result
      changed_when: usermod_result.rc == 0
      failed_when: false

    - name: Create .ssh directories for users
      file:
        path: "/home/{{ item.name }}/.ssh"
        state: directory
        owner: "{{ item.name }}"
        group: "{{ item.name }}"
        mode: "0700"
      loop: "{{ app_users }}"
      when: not item.system | default(false)

    - name: Configure authorized_keys for users
      copy:
        content: "{{ ssh_keys[item.name] | default('') }}"
        dest: "/home/{{ item.name }}/.ssh/authorized_keys"
        owner: "{{ item.name }}"
        group: "{{ item.name }}"
        mode: "0600"
      loop: "{{ app_users }}"
      when:
        - not item.system | default(false)
        - ssh_keys[item.name] is defined

    - name: Create user profile customizations
      copy:
        content: |
          # Custom profile for {{ item.name }}
          # Generated by Rustible

          export EDITOR=vim
          export HISTSIZE=10000
          export HISTFILESIZE=20000

          alias ll='ls -la'
          alias la='ls -A'
          alias l='ls -CF'

          # Custom prompt
          PS1='\[\033[01;32m\]\u@\h\[\033[00m\]:\[\033[01;34m\]\w\[\033[00m\]\$ '
        dest: "/home/{{ item.name }}/.bash_profile"
        owner: "{{ item.name }}"
        group: "{{ item.name }}"
        mode: "0644"
      loop: "{{ app_users }}"
      when: not item.system | default(false)

    - name: Configure sudoers for passwordless sudo
      copy:
        content: |
          # Sudoers configuration for {{ item }}
          # Generated by Rustible
          {{ item }} ALL=(ALL) NOPASSWD: ALL
        dest: "/etc/sudoers.d/{{ item }}"
        mode: "0440"
        validate: 'echo "Validation simulated for %s"'
      loop: "{{ sudoers_nopasswd }}"

    - name: Set up SSH configuration for users
      template:
        src: ssh_config.j2
        dest: "/home/{{ item.name }}/.ssh/config"
        owner: "{{ item.name }}"
        group: "{{ item.name }}"
        mode: "0600"
      loop: "{{ app_users }}"
      when: not item.system | default(false)

    - name: Verify user creation
      command: id {{ item.name }}
      loop: "{{ app_users }}"
      register: user_verification
      changed_when: false

    - name: Display user information
      debug:
        msg: "User {{ item.item.name }}: {{ item.stdout }}"
      loop: "{{ user_verification.results }}"

    - name: Create user activity log directory
      file:
        path: /var/log/user-activity
        state: directory
        owner: root
        group: root
        mode: "0755"

    - name: Configure user session logging
      copy:
        content: |
          # Log user sessions
          # Managed by Rustible
          session required pam_exec.so /usr/local/bin/log_session.sh
        dest: /etc/pam.d/session-logging
        mode: "0644"
