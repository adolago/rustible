# E2E Test Playbook: Database Configuration
# Tests: file, copy, template, lineinfile, blockinfile, command modules
---
- name: Database Server Configuration
  hosts: databases
  become: true
  gather_facts: true
  vars:
    db_name: rustible_app
    db_user: app_user
    db_password: "{{ vault_db_password | default('secure_test_password_123') }}"
    db_port: 5432
    pg_version: "16"
    pg_data_dir: /var/lib/postgresql/{{ pg_version }}/main
    pg_config_dir: /etc/postgresql/{{ pg_version }}/main
    max_connections: 100
    shared_buffers: "256MB"
    work_mem: "4MB"

  tasks:
    - name: Create PostgreSQL directories
      file:
        path: "{{ item }}"
        state: directory
        owner: postgres
        group: postgres
        mode: "0700"
      loop:
        - "{{ pg_data_dir }}"
        - "{{ pg_config_dir }}"
        - /var/log/postgresql
        - /var/run/postgresql
      ignore_errors: true  # postgres user might not exist in test container

    - name: Create PostgreSQL configuration
      template:
        src: postgresql.conf.j2
        dest: "{{ pg_config_dir }}/postgresql.conf"
        owner: root
        group: root
        mode: "0644"
      notify: reload postgresql

    - name: Create pg_hba.conf for authentication
      template:
        src: pg_hba.conf.j2
        dest: "{{ pg_config_dir }}/pg_hba.conf"
        owner: root
        group: root
        mode: "0640"
      notify: reload postgresql

    - name: Create database initialization script
      copy:
        content: |
          -- Database initialization script
          -- Generated by Rustible E2E tests

          -- Create application database
          CREATE DATABASE {{ db_name }} WITH
              ENCODING 'UTF8'
              LC_COLLATE 'en_US.UTF-8'
              LC_CTYPE 'en_US.UTF-8';

          -- Create application user
          CREATE USER {{ db_user }} WITH PASSWORD '{{ db_password }}';

          -- Grant privileges
          GRANT ALL PRIVILEGES ON DATABASE {{ db_name }} TO {{ db_user }};

          -- Create extension for UUID support
          \c {{ db_name }}
          CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
        dest: /tmp/init_db.sql
        mode: "0600"

    - name: Create backup directory
      file:
        path: /var/backups/postgresql
        state: directory
        owner: postgres
        group: postgres
        mode: "0750"
      ignore_errors: true

    - name: Create backup script
      copy:
        content: |
          #!/bin/bash
          # PostgreSQL backup script
          # Generated by Rustible E2E tests

          BACKUP_DIR=/var/backups/postgresql
          DATE=$(date +%Y%m%d_%H%M%S)
          DB_NAME="{{ db_name }}"

          pg_dump -U postgres $DB_NAME > $BACKUP_DIR/${DB_NAME}_$DATE.sql

          # Compress backup
          gzip $BACKUP_DIR/${DB_NAME}_$DATE.sql

          # Remove backups older than 7 days
          find $BACKUP_DIR -name "*.sql.gz" -mtime +7 -delete

          echo "Backup completed: ${DB_NAME}_$DATE.sql.gz"
        dest: /usr/local/bin/backup_db.sh
        mode: "0755"

    - name: Add custom PostgreSQL settings
      blockinfile:
        path: "{{ pg_config_dir }}/postgresql.conf"
        marker: "# {mark} RUSTIBLE MANAGED BLOCK"
        block: |
          # Performance tuning
          effective_cache_size = 768MB
          maintenance_work_mem = 128MB
          checkpoint_completion_target = 0.9
          wal_buffers = 16MB
          default_statistics_target = 100
          random_page_cost = 1.1
          effective_io_concurrency = 200
      notify: reload postgresql

    - name: Configure connection limits
      lineinfile:
        path: "{{ pg_config_dir }}/postgresql.conf"
        regexp: '^#?max_connections\s*='
        line: "max_connections = {{ max_connections }}"
      notify: reload postgresql

    - name: Set shared buffers
      lineinfile:
        path: "{{ pg_config_dir }}/postgresql.conf"
        regexp: '^#?shared_buffers\s*='
        line: "shared_buffers = {{ shared_buffers }}"
      notify: reload postgresql

    - name: Verify configuration files
      stat:
        path: "{{ item }}"
      loop:
        - "{{ pg_config_dir }}/postgresql.conf"
        - "{{ pg_config_dir }}/pg_hba.conf"
        - /usr/local/bin/backup_db.sh
      register: config_files

    - name: Report configuration status
      debug:
        msg: "{{ item.item }}: {{ 'exists' if item.stat.exists else 'missing' }}"
      loop: "{{ config_files.results }}"

  handlers:
    - name: reload postgresql
      command: echo "PostgreSQL reload simulated"
      listen: reload postgresql
