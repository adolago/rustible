# E2E Test Playbook: Multi-Tier Application Setup
# Tests: Complex orchestration across multiple hosts and roles
---
# Play 1: Common setup across all hosts
- name: Common Infrastructure Setup
  hosts: all
  become: true
  gather_facts: true
  vars:
    ntp_servers:
      - 0.pool.ntp.org
      - 1.pool.ntp.org
    common_packages:
      - curl
      - wget
      - vim
      - htop
    timezone: UTC

  tasks:
    - name: Set hostname
      copy:
        content: "{{ inventory_hostname }}"
        dest: /etc/hostname
        mode: "0644"

    - name: Update /etc/hosts
      lineinfile:
        path: /etc/hosts
        line: "{{ item }}"
        create: true
        mode: "0644"
      loop:
        - "127.0.0.1 localhost"
        - "{{ ansible_default_ipv4.address | default('127.0.0.1') }} {{ inventory_hostname }} {{ inventory_hostname }}.local"

    - name: Create common directories
      file:
        path: "{{ item }}"
        state: directory
        mode: "0755"
      loop:
        - /opt/scripts
        - /var/log/app
        - /etc/app

    - name: Deploy common configuration
      copy:
        content: |
          # Common system configuration
          # Managed by Rustible

          ENVIRONMENT={{ env | default('production') }}
          DATACENTER={{ datacenter | default('dc1') }}
          ROLE={{ role_name | default('unknown') }}
        dest: /etc/app/common.conf
        mode: "0644"

# Play 2: Load Balancer / Web Tier Configuration
- name: Web Tier Configuration
  hosts: webservers
  become: true
  gather_facts: false
  vars:
    role_name: webserver
    upstream_servers: "{{ groups['appservers'] | default(['app1', 'app2']) }}"
    upstream_port: 8080

  tasks:
    - name: Set role fact
      set_fact:
        role_name: webserver

    - name: Create upstream configuration
      template:
        src: upstream.conf.j2
        dest: /etc/nginx/conf.d/upstream.conf
        mode: "0644"
      notify: reload nginx

    - name: Configure reverse proxy
      copy:
        content: |
          # Reverse proxy configuration for upstream app servers
          # Generated by Rustible

          upstream app_backend {
            least_conn;
            {% for server in upstream_servers %}
            server {{ server }}:{{ upstream_port }} weight=1 max_fails=3 fail_timeout=30s;
            {% endfor %}
          }

          server {
              listen 80;
              server_name {{ inventory_hostname }};

              location / {
                  proxy_pass http://app_backend;
                  proxy_set_header Host $host;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto $scheme;

                  proxy_connect_timeout 30s;
                  proxy_send_timeout 60s;
                  proxy_read_timeout 60s;
              }

              location /health {
                  access_log off;
                  return 200 "healthy\n";
                  add_header Content-Type text/plain;
              }

              location /nginx_status {
                  stub_status on;
                  access_log off;
                  allow 127.0.0.1;
                  deny all;
              }
          }
        dest: /etc/nginx/sites-available/app-proxy
        mode: "0644"
      notify: reload nginx

    - name: Enable proxy site
      file:
        src: /etc/nginx/sites-available/app-proxy
        dest: /etc/nginx/sites-enabled/app-proxy
        state: link
      notify: reload nginx

  handlers:
    - name: reload nginx
      command: echo "Nginx reload for {{ inventory_hostname }}"

# Play 3: Application Tier Configuration
- name: Application Tier Configuration
  hosts: appservers
  become: true
  gather_facts: false
  vars:
    role_name: appserver
    db_host: "{{ groups['databases'][0] | default('db1') }}"
    app_port: 8080
    worker_count: 4

  tasks:
    - name: Set role fact
      set_fact:
        role_name: appserver

    - name: Create application configuration
      copy:
        content: |
          # Application server configuration
          # Host: {{ inventory_hostname }}
          # Generated by Rustible

          [server]
          host = 0.0.0.0
          port = {{ app_port }}
          workers = {{ worker_count }}

          [database]
          host = {{ db_host }}
          port = 5432
          pool_size = 10
          timeout = 30

          [cache]
          enabled = true
          type = redis
          host = localhost
          port = 6379

          [logging]
          level = info
          format = json
          file = /var/log/app/application.log
        dest: /etc/app/server.conf
        mode: "0644"
      notify: restart app

    - name: Create health check script
      copy:
        content: |
          #!/bin/bash
          # Health check for application
          curl -sf http://localhost:{{ app_port }}/health || exit 1
        dest: /opt/scripts/health_check.sh
        mode: "0755"

    - name: Configure application service
      copy:
        content: |
          [Unit]
          Description=Application Service
          After=network.target

          [Service]
          Type=simple
          User=appuser
          ExecStart=/opt/apps/current/bin/app start
          ExecStop=/opt/apps/current/bin/app stop
          Restart=always
          RestartSec=5

          [Install]
          WantedBy=multi-user.target
        dest: /etc/systemd/system/app.service
        mode: "0644"

  handlers:
    - name: restart app
      command: echo "Application restart for {{ inventory_hostname }}"

# Play 4: Database Tier Configuration
- name: Database Tier Configuration
  hosts: databases
  become: true
  gather_facts: false
  vars:
    role_name: database
    allowed_hosts: "{{ groups['appservers'] | default(['app1', 'app2']) }}"

  tasks:
    - name: Set role fact
      set_fact:
        role_name: database

    - name: Configure database access rules
      copy:
        content: |
          # PostgreSQL access configuration
          # Generated by Rustible

          # TYPE  DATABASE        USER            ADDRESS                 METHOD

          # Local connections
          local   all             postgres                                peer
          local   all             all                                     peer

          # IPv4 local connections
          host    all             all             127.0.0.1/32            md5

          # Application servers
          {% for host in allowed_hosts %}
          host    all             app_user        {{ host }}/32           md5
          {% endfor %}

          # Monitoring
          host    all             monitor         0.0.0.0/0               reject
        dest: /etc/postgresql/16/main/pg_hba.conf
        mode: "0640"
      notify: reload postgres

    - name: Configure database for replication readiness
      copy:
        content: |
          # Replication configuration
          wal_level = replica
          max_wal_senders = 5
          wal_keep_size = 1GB
          hot_standby = on
        dest: /etc/postgresql/16/main/conf.d/replication.conf
        mode: "0644"
      notify: reload postgres

  handlers:
    - name: reload postgres
      command: echo "PostgreSQL reload for {{ inventory_hostname }}"

# Play 5: Verification and Reporting
- name: Deployment Verification
  hosts: all
  become: true
  gather_facts: false

  tasks:
    - name: Gather deployment facts
      set_fact:
        deployment_info:
          host: "{{ inventory_hostname }}"
          role: "{{ role_name | default('unknown') }}"
          timestamp: "{{ ansible_date_time.iso8601 | default('unknown') }}"

    - name: Create deployment marker
      copy:
        content: |
          {
            "host": "{{ inventory_hostname }}",
            "role": "{{ role_name | default('unknown') }}",
            "deployed_at": "{{ ansible_date_time.iso8601 | default('unknown') }}",
            "version": "1.0.0"
          }
        dest: /etc/app/deployment.json
        mode: "0644"

    - name: Report deployment status
      debug:
        msg: |
          Deployment complete on {{ inventory_hostname }}
          Role: {{ role_name | default('unknown') }}
          All services configured successfully
