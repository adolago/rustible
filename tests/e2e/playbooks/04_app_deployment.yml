# E2E Test Playbook: Application Deployment
# Tests: file, copy, template, command, stat, unarchive simulation
---
- name: Application Deployment
  hosts: appservers
  become: true
  gather_facts: true
  vars:
    app_name: rustible_demo_app
    app_version: "1.2.3"
    app_user: appuser
    app_group: appuser
    deploy_root: /opt/apps
    current_link: "{{ deploy_root }}/current"
    releases_dir: "{{ deploy_root }}/releases"
    shared_dir: "{{ deploy_root }}/shared"

    app_config:
      environment: production
      debug: false
      log_level: info
      database:
        host: db1
        port: 5432
        name: rustible_app
      redis:
        host: localhost
        port: 6379
      features:
        rate_limiting: true
        caching: true
        metrics: true

    keep_releases: 5

  tasks:
    - name: Create deployment directory structure
      file:
        path: "{{ item }}"
        state: directory
        owner: "{{ app_user }}"
        group: "{{ app_group }}"
        mode: "0755"
      loop:
        - "{{ deploy_root }}"
        - "{{ releases_dir }}"
        - "{{ shared_dir }}"
        - "{{ shared_dir }}/config"
        - "{{ shared_dir }}/log"
        - "{{ shared_dir }}/tmp"
        - "{{ shared_dir }}/pids"
        - "{{ shared_dir }}/sockets"

    - name: Set release timestamp
      set_fact:
        release_timestamp: "{{ ansible_date_time.epoch | default('1234567890') }}"
        release_dir: "{{ releases_dir }}/{{ ansible_date_time.epoch | default('1234567890') }}"

    - name: Create release directory
      file:
        path: "{{ release_dir }}"
        state: directory
        owner: "{{ app_user }}"
        group: "{{ app_group }}"
        mode: "0755"

    - name: Create application structure
      file:
        path: "{{ release_dir }}/{{ item }}"
        state: directory
        owner: "{{ app_user }}"
        group: "{{ app_group }}"
        mode: "0755"
      loop:
        - bin
        - lib
        - config
        - public
        - logs

    - name: Deploy application binary (simulated)
      copy:
        content: |
          #!/bin/bash
          # {{ app_name }} v{{ app_version }}
          # Simulated application binary for E2E testing

          case "$1" in
            start)
              echo "Starting {{ app_name }}..."
              echo $$ > {{ shared_dir }}/pids/app.pid
              ;;
            stop)
              echo "Stopping {{ app_name }}..."
              rm -f {{ shared_dir }}/pids/app.pid
              ;;
            status)
              if [ -f {{ shared_dir }}/pids/app.pid ]; then
                echo "{{ app_name }} is running"
              else
                echo "{{ app_name }} is stopped"
              fi
              ;;
            *)
              echo "Usage: $0 {start|stop|status}"
              exit 1
              ;;
          esac
        dest: "{{ release_dir }}/bin/app"
        owner: "{{ app_user }}"
        group: "{{ app_group }}"
        mode: "0755"

    - name: Deploy application configuration
      template:
        src: app_config.yml.j2
        dest: "{{ shared_dir }}/config/application.yml"
        owner: "{{ app_user }}"
        group: "{{ app_group }}"
        mode: "0640"

    - name: Deploy environment file
      copy:
        content: |
          # Environment configuration for {{ app_name }}
          # Generated by Rustible at {{ ansible_date_time.iso8601 | default('unknown') }}

          APP_NAME={{ app_name }}
          APP_VERSION={{ app_version }}
          APP_ENV={{ app_config.environment }}
          APP_DEBUG={{ app_config.debug | lower }}

          DATABASE_HOST={{ app_config.database.host }}
          DATABASE_PORT={{ app_config.database.port }}
          DATABASE_NAME={{ app_config.database.name }}

          REDIS_HOST={{ app_config.redis.host }}
          REDIS_PORT={{ app_config.redis.port }}

          LOG_LEVEL={{ app_config.log_level }}
          LOG_DIR={{ shared_dir }}/log

          PID_FILE={{ shared_dir }}/pids/app.pid
          SOCKET_FILE={{ shared_dir }}/sockets/app.sock
        dest: "{{ shared_dir }}/config/.env"
        owner: "{{ app_user }}"
        group: "{{ app_group }}"
        mode: "0600"

    - name: Create symlinks to shared directories
      file:
        src: "{{ shared_dir }}/{{ item }}"
        dest: "{{ release_dir }}/{{ item }}"
        state: link
        owner: "{{ app_user }}"
        group: "{{ app_group }}"
      loop:
        - config
        - logs

    - name: Update current symlink
      file:
        src: "{{ release_dir }}"
        dest: "{{ current_link }}"
        state: link
        owner: "{{ app_user }}"
        group: "{{ app_group }}"
      notify: restart application

    - name: Create systemd service file (simulated)
      copy:
        content: |
          [Unit]
          Description={{ app_name }}
          After=network.target

          [Service]
          Type=simple
          User={{ app_user }}
          Group={{ app_group }}
          WorkingDirectory={{ current_link }}
          ExecStart={{ current_link }}/bin/app start
          ExecStop={{ current_link }}/bin/app stop
          ExecReload=/bin/kill -HUP $MAINPID
          PIDFile={{ shared_dir }}/pids/app.pid
          Restart=on-failure
          RestartSec=5

          [Install]
          WantedBy=multi-user.target
        dest: /etc/systemd/system/{{ app_name }}.service
        owner: root
        group: root
        mode: "0644"
      notify: reload systemd

    - name: List old releases for cleanup
      command: ls -1t {{ releases_dir }}
      register: releases_list
      changed_when: false

    - name: Clean up old releases
      file:
        path: "{{ releases_dir }}/{{ item }}"
        state: absent
      loop: "{{ releases_list.stdout_lines[keep_releases:] | default([]) }}"
      when: releases_list.stdout_lines | length > keep_releases

    - name: Verify deployment
      stat:
        path: "{{ item }}"
      loop:
        - "{{ current_link }}"
        - "{{ current_link }}/bin/app"
        - "{{ shared_dir }}/config/application.yml"
        - "{{ shared_dir }}/config/.env"
      register: deploy_verification

    - name: Report deployment status
      debug:
        msg: |
          Deployment verification:
          {% for result in deploy_verification.results %}
          - {{ result.item }}: {{ 'OK' if result.stat.exists else 'MISSING' }}
          {% endfor %}

  handlers:
    - name: restart application
      command: echo "Application restart simulated for {{ app_name }}"
      listen: restart application

    - name: reload systemd
      command: echo "Systemd daemon-reload simulated"
      listen: reload systemd
