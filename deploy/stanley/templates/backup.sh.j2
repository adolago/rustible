#!/bin/bash
# Stanley Backup Script
# Generated by Rustible deployment

set -euo pipefail

# Configuration
BACKUP_DIR="/var/backups/stanley"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
BACKUP_NAME="stanley_backup_${TIMESTAMP}"
RETENTION_DAYS={{ backup_retention_days | default(30) }}
S3_BUCKET="{{ backup_s3_bucket | default('stanley-backups') }}"

# Database configuration
POSTGRES_DB="{{ postgres_db }}"
POSTGRES_USER="{{ postgres_user }}"
POSTGRES_PASSWORD="{{ postgres_password }}"

# Stanley configuration
STANLEY_DATA_DIR="{{ stanley_data_dir }}"
STANLEY_CONFIG_DIR="{{ stanley_config_dir }}"
STANLEY_LOGS_DIR="{{ stanley_logs_dir }}"

# Create backup directory
mkdir -p "${BACKUP_DIR}"

# Function to log messages
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $*" | tee -a "${BACKUP_DIR}/backup.log"
}

# Function to cleanup old backups
cleanup_old_backups() {
    log "Cleaning up backups older than ${RETENTION_DAYS} days"
    find "${BACKUP_DIR}" -name "stanley_backup_*" -type d -mtime +${RETENTION_DAYS} -exec rm -rf {} \;
}

# Function to backup database
backup_database() {
    log "Backing up PostgreSQL database"
    
    export PGPASSWORD="${POSTGRES_PASSWORD}"
    
    pg_dump -h localhost -U "${POSTGRES_USER}" -d "${POSTGRES_DB}}" \
        --clean --if-exists --create \
        --file "${BACKUP_DIR}/${BACKUP_NAME}/database.sql"
    
    unset PGPASSWORD
    
    log "Database backup completed"
}

# Function to backup application data
backup_app_data() {
    log "Backing up application data"
    
    # Backup data directory
    tar -czf "${BACKUP_DIR}/${BACKUP_NAME}/data.tar.gz" \
        -C "$(dirname "${STANLEY_DATA_DIR}")" \
        "$(basename "${STANLEY_DATA_DIR}")"
    
    # Backup configuration
    tar -czf "${BACKUP_DIR}/${BACKUP_NAME}/config.tar.gz" \
        -C "$(dirname "${STANLEY_CONFIG_DIR}")" \
        "$(basename "${STANLEY_CONFIG_DIR}")"
    
    # Backup logs (optional, may be large)
    if [[ "${BACKUP_LOGS:-false}" == "true" ]]; then
        tar -czf "${BACKUP_DIR}/${BACKUP_NAME}/logs.tar.gz" \
            -C "$(dirname "${STANLEY_LOGS_DIR}")" \
            "$(basename "${STANLEY_LOGS_DIR}")"
    fi
    
    log "Application data backup completed"
}

# Function to backup Redis data
backup_redis() {
    log "Backing up Redis data"
    
    redis-cli BGSAVE
    
    # Wait for background save to complete
    while [[ $(redis-cli LASTSAVE) -eq 0 ]]; do
        sleep 1
    done
    
    # Copy dump.rdb
    cp /var/lib/redis/dump.rdb "${BACKUP_DIR}/${BACKUP_NAME}/redis.rdb"
    
    log "Redis backup completed"
}

# Function to upload to S3 (if configured)
upload_to_s3() {
    if command -v aws &> /dev/null && [[ -n "${S3_BUCKET}" ]]; then
        log "Uploading backup to S3"
        
        aws s3 sync "${BACKUP_DIR}/${BACKUP_NAME}" \
            "s3://${S3_BUCKET}/${BACKUP_NAME}/" \
            --delete
        
        log "S3 upload completed"
    else
        log "S3 upload skipped (aws CLI not available or S3 bucket not configured)"
    fi
}

# Function to create backup metadata
create_metadata() {
    cat > "${BACKUP_DIR}/${BACKUP_NAME}/metadata.json" << EOF
{
    "timestamp": "${TIMESTAMP}",
    "hostname": "$(hostname)",
    "stanley_version": "$(cd {{ stanley_home }}/stanley && git describe --tags --always 2>/dev/null || echo 'unknown')",
    "database_size": "$(du -sh "${BACKUP_DIR}/${BACKUP_NAME}/database.sql" | cut -f1)",
    "data_size": "$(du -sh "${BACKUP_DIR}/${BACKUP_NAME}/data.tar.gz" | cut -f1)",
    "backup_type": "full"
}
EOF
}

# Main backup function
main() {
    log "Starting Stanley backup: ${BACKUP_NAME}"
    
    # Create backup directory
    mkdir -p "${BACKUP_DIR}/${BACKUP_NAME}"
    
    # Perform backups
    backup_database
    backup_app_data
    backup_redis
    create_metadata
    
    # Create compressed archive
    cd "${BACKUP_DIR}"
    tar -czf "${BACKUP_NAME}.tar.gz" "${BACKUP_NAME}"
    
    # Remove uncompressed directory
    rm -rf "${BACKUP_DIR}/${BACKUP_NAME}"
    
    # Upload to S3
    upload_to_s3
    
    # Cleanup old backups
    cleanup_old_backups
    
    log "Backup completed successfully: ${BACKUP_NAME}.tar.gz"
    log "Backup size: $(du -sh "${BACKUP_DIR}/${BACKUP_NAME}.tar.gz" | cut -f1)"
}

# Error handling
trap 'log "Backup failed with error: $?"; exit 1' ERR

# Run main function
main