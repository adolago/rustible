#!/bin/bash
# Stanley Maintenance Script
# Generated by Rustible deployment

set -euo pipefail

# Configuration
STANLEY_USER="{{ stanley_user }}"
STANLEY_HOME="{{ stanley_home }}"
STANLEY_DATA_DIR="{{ stanley_data_dir }}"
STANLEY_LOGS_DIR="{{ stanley_logs_dir }}"
STANLEY_CONFIG_DIR="{{ stanley_config_dir }}"

# Database configuration
POSTGRES_DB="{{ postgres_db }}"
POSTGRES_USER="{{ postgres_user }}"
POSTGRES_PASSWORD="{{ postgres_password }}"

# Function to log messages
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $*" | tee -a "${STANLEY_LOGS_DIR}/maintenance.log"
}

# Function to rotate logs
rotate_logs() {
    log "Rotating application logs"
    
    # Rotate Stanley logs
    find "${STANLEY_LOGS_DIR}" -name "*.log" -type f -exec logrotate -f {} \;
    
    # Rotate system logs
    logrotate -f /etc/logrotate.conf
    
    log "Log rotation completed"
}

# Function to clean up temporary files
cleanup_temp_files() {
    log "Cleaning up temporary files"
    
    # Clean temp directory
    find "${STANLEY_DATA_DIR}/temp" -type f -mtime +1 -delete 2>/dev/null || true
    
    # Clean old cache files
    find "${STANLEY_DATA_DIR}/cache" -type f -mtime +7 -delete 2>/dev/null || true
    
    # Clean old session files
    find /tmp -name "stanley_*" -type f -mtime +1 -delete 2>/dev/null || true
    
    log "Temporary files cleanup completed"
}

# Function to optimize database
database_maintenance() {
    log "Performing database maintenance"
    
    export PGPASSWORD="${POSTGRES_PASSWORD}"
    
    # Vacuum and analyze
    psql -h localhost -U "${POSTGRES_USER}" -d "${POSTGRES_DB}}" -c "VACUUM ANALYZE;"
    
    # Update statistics
    psql -h localhost -U "${POSTGRES_USER}" -d "${POSTGRES_DB}}" -c "SELECT pg_stat_reset();"
    
    # Check for unused indexes
    unused_indexes=$(psql -h localhost -U "${POSTGRES_USER}}" -d "${POSTGRES_DB}}" -t -c "
        SELECT schemaname, tablename, indexname 
        FROM pg_stat_user_indexes 
        WHERE idx_scan = 0 
        AND indexname NOT LIKE '%_pkey';
    ")
    
    if [[ -n "${unused_indexes}" ]]; then
        log "Unused indexes found: ${unused_indexes}"
    fi
    
    unset PGPASSWORD
    
    log "Database maintenance completed"
}

# Function to check disk space
check_disk_space() {
    log "Checking disk space"
    
    # Check data directory
    data_usage=$(df -h "${STANLEY_DATA_DIR}" | tail -1 | awk '{print $5}' | sed 's/%//')
    if [[ ${data_usage} -gt 80 ]]; then
        log "WARNING: Data directory usage is ${data_usage}%"
    fi
    
    # Check logs directory
    logs_usage=$(df -h "${STANLEY_LOGS_DIR}" | tail -1 | awk '{print $5}' | sed 's/%//')
    if [[ ${logs_usage} -gt 80 ]]; then
        log "WARNING: Logs directory usage is ${logs_usage}%"
    fi
    
    # Check root filesystem
    root_usage=$(df -h / | tail -1 | awk '{print $5}' | sed 's/%//')
    if [[ ${root_usage} -gt 85 ]]; then
        log "WARNING: Root filesystem usage is ${root_usage}%"
    fi
    
    log "Disk space check completed"
}

# Function to check service health
check_service_health() {
    log "Checking service health"
    
    # Check API service
    if systemctl is-active --quiet stanley-api; then
        log "Stanley API service is running"
        
        # Health check
        if curl -f -s http://localhost:{{ api_port }}/api/health > /dev/null; then
            log "Stanley API health check passed"
        else
            log "WARNING: Stanley API health check failed"
        fi
    else
        log "ERROR: Stanley API service is not running"
    fi
    
    # Check GUI service
    if systemctl is-active --quiet stanley-gui; then
        log "Stanley GUI service is running"
    else
        log "WARNING: Stanley GUI service is not running"
    fi
    
    log "Service health check completed"
}

# Function to update system packages
update_system_packages() {
    log "Checking for system package updates"
    
    # Update package cache
    apt-get update -qq
    
    # Check for available updates
    updates=$(apt list --upgradable 2>/dev/null | wc -l)
    
    if [[ ${updates} -gt 1 ]]; then
        log "Found ${updates} package updates available"
        log "Run 'apt-get upgrade' to install updates"
    else
        log "No package updates available"
    fi
    
    log "System package check completed"
}

# Function to check Redis health
check_redis_health() {
    log "Checking Redis health"
    
    if systemctl is-active --quiet redis-server; then
        log "Redis service is running"
        
        # Check Redis memory usage
        redis_memory=$(redis-cli INFO memory | grep used_memory_human | cut -d: -f2 | tr -d '\r')
        log "Redis memory usage: ${redis_memory}"
        
        # Check Redis connections
        redis_connections=$(redis-cli INFO clients | grep connected_clients | cut -d: -f2 | tr -d '\r')
        log "Redis connections: ${redis_connections}"
    else
        log "WARNING: Redis service is not running"
    fi
    
    log "Redis health check completed"
}

# Function to generate maintenance report
generate_report() {
    local report_file="${STANLEY_LOGS_DIR}/maintenance_report_$(date +%Y%m%d_%H%M%S).txt"
    
    cat > "${report_file}" << EOF
Stanley Maintenance Report
Generated: $(date)
Hostname: $(hostname)
Environment: {{ environment }}

System Information:
- OS: $(lsb_release -d | cut -f2)
- Kernel: $(uname -r)
- Uptime: $(uptime -p)

Disk Usage:
$(df -h)

Memory Usage:
$(free -h)

Service Status:
$(systemctl status stanley-api stanley-gui redis-server postgresql --no-pager)

Database Size:
$(sudo -u postgres psql -l | grep {{ postgres_db }})

Redis Info:
$(redis-cli INFO | grep -E "(used_memory_human|connected_clients|keyspace_hits|keyspace_misses)")

Recent Errors:
$(journalctl -u stanley-api -u stanley-gui --since "1 hour ago" --no-pager | grep -i error | tail -10)

EOF
    
    log "Maintenance report generated: ${report_file}"
}

# Main maintenance function
main() {
    log "Starting Stanley maintenance"
    
    # Perform maintenance tasks
    rotate_logs
    cleanup_temp_files
    database_maintenance
    check_disk_space
    check_service_health
    check_redis_health
    update_system_packages
    generate_report
    
    log "Stanley maintenance completed successfully"
}

# Error handling
trap 'log "Maintenance failed with error: $?"; exit 1' ERR

# Run main function
main